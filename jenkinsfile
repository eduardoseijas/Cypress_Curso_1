pipeline {
  // No reserves el master para todo; cada stage pedirá su agente
  agent none

  // Cambia 'node' si tu tool en Manage Jenkins → Tools tiene otro nombre
  tools { nodejs 'node' }

  // Si quieres, guarda la key en Credentials y usa credentials('cypress_key').
  environment {
    CYPRESS_RECORD_KEY = '68a58e64-711c-452e-bfcc-05c2d7e4ba14'
  }

  stages {
    stage('Cypress Parallel Test Suite') {
      parallel {
        stage('Slave 1') {
          agent { label 'Agent_1' }     // <-- tu único agente con 2 executors
          steps {
            git url: 'https://github.com/eduardoseijas/Cypress_Curso_1.git'
            bat 'npm ci'
            bat '''
              npx cypress run ^
                --browser chrome --headless ^
                --spec "cypress/e2e/26_Fixture_Carga_De_Informacion_Por_Archivos_Json/02_fixture_Cargando_Por_Alias.cy.js"
                --record --key %CYPRESS_RECORD_KEY% ^
                --parallel --group shard-A ^
                --ci-build-id %BUILD_TAG%
                
            '''
            // Si quieres correr un solo spec, añade:
            //IMPORTANTE ESTO SE AÑADE DEBAJO DE --browser chrome --headless ^, para que pueda correr uno y no todos
            //Eso para cada uno de los slave que crees
            // --spec "cypress/e2e/26_Fixture_Carga_De_Informacion_Por_Archivos_Json/02_fixture_Cargando_Por_Alias.cy.js"
          }
        }

        stage('Slave 2') {
          agent { label 'Agent_1' }     // <-- mismo label
          steps {
            git url: 'https://github.com/eduardoseijas/Cypress_Curso_1.git'
            bat 'npm ci'
            bat '''
              npx cypress run ^
                --browser chrome --headless ^
                 --spec "cypress/e2e/26_Fixture_Carga_De_Informacion_Por_Archivos_Json/02_fixture_Cargando_Por_Alias.cy.js"
                --record --key %CYPRESS_RECORD_KEY% ^
                --parallel --group shard-B ^
                --ci-build-id %BUILD_TAG%
            '''
          }
        }
      }
    }
  }
}
